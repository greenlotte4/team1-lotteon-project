<!--
    날짜 : 2024/10/25
    이름 : 이상훈
    내용 : 상품 페이지 리스트 보기 컨텐츠 생성

    - 수정내역
    - tymeleaf 레이아웃 적용 (10/28 준혁)
-->
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{product/layout/product_layout}">

<!-- index.html 고유 CSS 추가 -->
<th:block layout:fragment="css">
    <link rel="stylesheet" th:href="@{/css/include/reset.css}">
    <link rel="stylesheet" th:href="@{/css/product/product.css}">
    <link rel="stylesheet" th:href="@{/css/product/view.css}">
</th:block>

<!-- index.html 고유 스크립트 추가 -->
<th:block layout:fragment="script">
    <script type="text/javascript" th:src="@{/js/util.js}"></script>
    <script type="text/javascript" th:src="@{/js/product/view.js}"></script>
    <script src="https://kit.fontawesome.com/63c07008cd.js" crossorigin="anonymous"></script>
</th:block>

<section class="section" layout:fragment="content">

    <nav class="section__nav navsticky">
        <h1>상품보기</h1>
        <p>
            HOME
            <span> > </span>
            <span>패션·의류·뷰티</span>
            <span> > </span>
            <strong>남성의류</strong>
        </p>
    </nav>

    <!-- 상품 전체 정보 내용 -->
    <article class="info">
        <div class="image">
            <img th:src="'/'+${appInfo.uploadDir}+'product/'+${product.productImg3}" alt="상품이미지" />
        </div>
        <div class="summary">
            <nav class="summary__nav">
                <h1 class="summary__nav__company">(주)상호명</h1>
                <h2 class="summary__nav__product">상품번호&nbsp;:&nbsp;<span id="prodNo">[[${product.id}]]</span></h2>
            </nav>

            <!-- 상품명과 별점 -->
            <nav class="summary__product">
                <div class="product-header">
                    <h3>[[${product.productName}]]</h3>
                    <div class="rating">
                        <img src="/images/star-rating.png" alt="별점" />
                        <span>4.8</span> <span>(27건)</span>
                    </div>
                </div>
                <p class="summary__product-info">[[${product.description}]]</p>
            </nav>

            <!-- 가격과 혜택 -->
            <h4 class="section-title">가격 정보</h4>
            <nav class="summary__price">
                <div class="price-group">
                    <div class="original-price">
                        <del id="prodPrice" class="org_price">[[${product.price}]]원</del>
                        <span id="disCount" class="discount">[[${product.discountRate}]]%↓</span>
                    </div>
                    <ins id="disPrice" class="dis_price">[[${product.discountedPrice}]] 원</ins> <!-- 최종 가격 -->
                </div>
                <button class="coupon-button"><i class="fa-solid fa-tag"></i> 쿠폰 받기</button>
            </nav>

            <h4 class="section-title">혜택 정보</h4>
            <div class="summary__card">
                <span class="card cardFree"><i class="fa-solid fa-credit-card"></i>무이자할부</span>
                <span class="card cardAdd"><i class="fa-solid fa-credit-card"></i>카드추가혜택</span>
            </div>


            <!-- 배송 정보 -->
            <h4 class="section-title">배송 정보</h4>
            <nav class="summary__delivery">
                <div class="delivery-item">
                    <span class="delivery-label"><i class="fa-solid fa-truck"></i> 배송비:</span>
                    <span class="delivery">[[${product.deliveryFee}]]원</span>
                </div>
                <div class="delivery-item">
                    <span class="delivery-label"><i class="fa-solid fa-calendar-day"></i> 도착 예정:</span>
                    <span class="arrival" id="arrivalDate">모레 (금) 7/8 도착예정</span>
                </div>
                <div class="desc">본 상품은 국내배송만 가능합니다.</div>
            </nav>

            <!-- 선택 옵션 추가 -->
            <th:block th:if="${product.getProductOptions().size()} > 0">
                <h4 class="section-title">선택 옵션</h4>
            </th:block>
            <div class="selectedOption">
                <th:block th:each="ProductOption, i:${product.getProductOptions()}">
                    <div class="options_choose">
                        <label for="optionSelect[[${i}]]">[[${ProductOption.name}]]:</label>
                        <select id="optionSelect[[${i}]]" onchange="updateSelectedOptions()">
                            <option value="">옵션을 선택하세요</option>
                            <th:block th:each="optionitem : ${ProductOption.getOptionitems()}">
                                <option th:value="${optionitem.id}" >[[${optionitem.value}]]</option>
                            </th:block>
                        </select>
                    </div>
                </th:block>
            </div>

            <!-- 수량 선택 -->
            <h4 class="section-title">수량 선택</h4>
            <div class="selectedValue">
                <div class="count">
                    <button class="count-button decrease" onclick="changeNumNoOpt(-1)">
                        <i class="fa-solid fa-minus"></i>
                    </button>
                    <!-- oninput 이벤트를 통해 키보드 입력 시 checkMaxStock 함수 호출 -->
                    <input class="count__input" type="number" min="1" name="num" id="numInput" value="1" oninput="updateTotalPrice();"  />
                    <button class="count-button increase" onclick="changeNumNoOpt(1)">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
            </div>

            <!-- 총 금액 표시 -->
            <div class="total">
                <span class="total__price-name">총 상품금액</span>
                <span class="total__price-value" id="totalPrice">[[${product.discountedPrice}]]원</span>
            </div>

            <!-- 장바구니 구매하기 버튼 그룹 -->
            <div class="button-group">
                <button onclick="if (validateBeforeAction()) window.location.href='/product/order'" class="button-group__btn button-group__order">
                    <i class="fa-solid fa-credit-card"></i> 구매하기
                </button>
                <button onclick="addToCart()" class="button-group__btn button-group__cart">
                    <i class="fa-solid fa-cart-shopping"></i> 장바구니
                </button>
            </div>

        </div>
    </article>


    <article class="notice">
        <!-- 기본 정보 테이블 -->
        <table class="info-table">
            <tr>
                <td>상품번호</td>
                <td>[[${product.id}]]</td>
            </tr>
            <tr>
                <td>상품상태</td>
                <td>[[${product.productStatus}]]</td>
            </tr>
            <tr>
                <td>부가세 면세여부</td>
                <td>[[${product.warranty}]]</td>
            </tr>
            <tr>
                <td>영수증발행</td>
                <td>[[${product.receiptIssued}]]</td>
            </tr>
            <tr>
                <td>사업자구분</td>
                <td>[[${product.businessType}]]</td>
            </tr>
            <tr>
                <td>원산지</td>
                <td>[[${product.origin}]]</td>
            </tr>
        </table>

        <!-- 구분선 -->
        <div class="divider"></div>

        <!-- 상세 정보 테이블 -->
        <table class="detail-table">
            <tr>
                <td>제품소재</td>
                <td>컨텐츠 참조</td>
            </tr>
            <tr>
                <td>색상</td>
                <td>컨텐츠 참조</td>
            </tr>
            <tr>
                <td>치수</td>
                <td>컨텐츠 참조</td>
            </tr>
            <tr>
                <td>제조자/수입국</td>
                <td>컨텐츠 참조 / 대한민국</td>
            </tr>
            <tr>
                <td>제조국</td>
                <td>컨텐츠 참조</td>
            </tr>
            <tr>
                <td>취급시 주의사항</td>
                <td>제품 사용 설명서 참조</td>
            </tr>
            <tr>
                <td>제조연월</td>
                <td>컨텐츠 참조</td>
            </tr>
            <tr>
                <td>품질보증기준</td>
                <td>제품 이상 시 공정거래위원회 고시 소비자분쟁해결기준에 의거 보상합니다.</td>
            </tr>
            <tr>
                <td>A/S 책임자와 전화번호</td>
                <td>롯데ON 고객센터(1899-7000)</td>
            </tr>
            <tr>
                <td>주문후 예상 배송기간</td>
                <td>전국 평균 기준 배송 후 3일 이내 도착</td>
            </tr>
            <tr>
                <td colspan="2">구매, 교환, 반품, 배송, 설치 등과 관련하여 추가비용, 제한조건 등의 특이사항이 있는 경우</td>
            </tr>
        </table>

        <div class="button-container">
            <button class="toggle-button" onclick="toggleDetails()">
                더 많은 상품정보를 확인해보세요
                <span class="toggle-icon">▼</span>
            </button>
        </div>
    </article>

    <section class="bottom_section">
        <!-- 왼쪽 상품 정보와 상세 이미지 -->
        <div class="product-content">
            <div class="product-info">
                <!-- 상단 네비게이션 바 -->
                <nav class="product-nav">
                    <button class="nav-btn" onclick="scrollToSection('detail')">상세정보</button>
                    <button class="nav-btn" onclick="scrollToSection('review')">리뷰</button>
                    <button class="nav-btn" onclick="scrollToSection('qna')">Q&A</button>
                    <button class="nav-btn" onclick="scrollToSection('return')">교환반품안내</button>
                </nav>

                <!-- 상품정보 및 이미지 -->
                <div id="detail">
                    <h1>상품정보</h1>
                    <img class="section__product-img" src="https://thumbnail9.coupangcdn.com/thumbnails/remote/q89/image/retail/images/428998748346131-02d256a7-51f3-44c7-a66d-99431f86c7e2.jpg" alt="상세페이지1" />
                </div>
            </div>

            <aside class="cart-summary">
                <div class="bottom_cart">
                    <div class="cart-option">
                        <label for="optionSelect1">상품명</label>
                        <select id="optionSelect1">
                            <option>01_제주감귤 소자 2.5kg</option>
                            <option value="option1">옵션 1</option>
                            <option value="option2">옵션 2</option>
                        </select>

                        <label for="optionSelect2">선택옵션</label>
                        <select id="optionSelect2">
                            <option>1BOX</option>
                            <option value="2box">2BOX</option>
                            <option value="3box">3BOX</option>
                        </select>
                    </div>

                    <div class="cart-info">
                        <p><strong>배송 정보:</strong> 10/30 (수) 도착 예정 (87% 확률)</p>
                        <p><strong>판매자:</strong> 에이블로우컴퍼니</p>
                    </div>

                    <div class="cart-item">
                        <div class="quantity">
                            <label for="count-input">수량</label>
                            <div class="quantity-controls">
                                <button class="count-btn decrease">-</button>
                                <input type="text" id="count-input" value="1" class="count-input">
                                <button class="count-btn increase">+</button>
                            </div>
                        </div>
                        <div class="price">
                            <strong>가격:</strong> <span class="price-value">10,170원</span>
                        </div>
                    </div>

                    <div class="cart-actions">
                        <button class="cart-action-btn gift-btn"><i class="fa-solid fa-gift"></i> 선물하기</button>
                        <button class="cart-action-btn cart-btn"><i class="fa-solid fa-shopping-cart"></i> 장바구니 담기</button>
                        <button class="cart-action-btn buy-btn"><i class="fa-solid fa-credit-card"></i> 바로 구매하기</button>
                    </div>
                </div>
            </aside>
        </div>
    </section>

    <!-- 상품 리뷰 내용 -->
    <nav class="section__review-nav" style="padding-bottom: 0">
        <h1>상품 리뷰</h1>
    </nav>

    <article class="review">
        <nav class="review__head">
            <span class="review__count">리뷰 45</span>
            <span class="review__rate">리뷰 평점 <span class="review__rate__score">4.5</span></span>
            <button class="button-group__btn review__write" onclick="(function(){window.location.href='/product/review/write'})()">리뷰 작성</button>
        </nav>
        <nav class="review__list">
            <div class="review__item">
                <h3 class="review__item__title">리뷰 제목</h3>
                <div class="review__item__desc">리뷰 내용입니다. 이곳에 리뷰 내용을 적어주세요.</div>
                <span class="review__item__author">작성자: 고객 이름</span>
                <span class="review__item__date">작성일: 2024.01.01</span>
            </div>
            <div class="review__item">
                <h3 class="review__item__title">리뷰 제목</h3>
                <div class="review__item__desc">리뷰 내용입니다. 이곳에 리뷰 내용을 적어주세요.</div>
                <span class="review__item__author">작성자: 고객 이름</span>
                <span class="review__item__date">작성일: 2024.01.01</span>
            </div>
        </nav>
    </article>

    <!-- 버튼 -->
    <div style="text-align:center; margin: 30px 0;">
        <button onclick="(function(){window.location.href='/'})()" class="button-group__btn button-group__home">홈으로</button>
    </div>
    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function() {
            let optionCombinations = /*[[${optionCombinations}]]*/ {};
            let selectedOptions = {}; // 사용자가 선택한 옵션을 저장하는 객체
            let unitPrice = parseFloat(document.getElementById("disPrice").textContent.replace(/[^0-9.-]+/g, "")); // 할인된 가격
            let productOptionsCount = /*[[${#lists.size(product.getProductOptions())}]]*/ 0; // 옵션사이즈

            console.log("옵션 조합 데이터:", optionCombinations);
            console.log("현재 선택된 옵션:", selectedOptions); // 객체 자체를 단독으로 출력
            console.log("현재 선택된 옵션(JSON):", JSON.stringify(selectedOptions, null, 2)); // JSON 형태로 보기 좋게 출력

            // Update selected options dynamically
            function updateSelectedOptions() {
                document.querySelectorAll('.options_choose select').forEach((select) => {
                    const optionName = select.previousElementSibling.textContent.replace(":", "").trim();
                    const optionValue = select.value ? parseInt(select.value, 10) : null;

                    if (optionValue !== null && !isNaN(optionValue)) {
                        selectedOptions[optionName] = optionValue;
                    } else {
                        delete selectedOptions[optionName]; // 빈 값일 경우 키 삭제
                    }
                });

                console.log("현재 선택된 옵션:", selectedOptions);

                // 옵션 선택이 완료된 경우만 재고 확인
                if (areAllOptionsSelected()) {
                    checkMaxStock();
                } else {
                    console.log("모든 옵션이 선택되지 않았습니다.");
                }
            }

            // 옵션 모두 체크했는지 검사하는 유효성검사 메서드
            function areAllOptionsSelected() {
                // 선택된 옵션의 개수가 productOptionsCount와 일치하는지 확인
                if (Object.keys(selectedOptions).length !== productOptionsCount) {
                    console.log("모든 옵션이 선택되지 않았습니다.");
                    return false;
                }

                const allSelected = Object.values(selectedOptions).every(value =>
                    value !== null && value !== '' && value !== undefined && !isNaN(value)
                );

                console.log('모든 옵션 선택 상태:', allSelected);
                return allSelected;
            }


            // 선택된 옵션에 맞는 재고 및 combinationId 찾기
            function getDetailsForSelectedOptions() {
                const optionKey = JSON.stringify(Object.values(selectedOptions).sort((a, b) => a - b));
                console.log('키 ???' +optionKey );
                const details = optionCombinations[optionKey];
                console.log('찾았나???' +details );
                return details ? details : { combinationId: null, stock: 0 };
            }

            function getStockForSelectedOptions() {

                const details = getDetailsForSelectedOptions();
                return details.stock;
            }

            // Check stock and update quantity input based on stock limits
            function checkMaxStock() {
                const quantityInput = document.getElementById("numInput");
                const selectedQuantity = parseInt(quantityInput.value, 10) || 1;

                if (!areAllOptionsSelected()) {
                    alert("옵션을 먼저 선택해주세요.");
                    quantityInput.value = 1;
                    return;
                }
                const maxStock = getStockForSelectedOptions();
                console.log("최대 재고 확인:", maxStock);

                if (selectedQuantity > maxStock) {
                    alert(`최대 재고 수량은 ${maxStock}입니다!`);
                    quantityInput.value = maxStock;
                    updateTotalPrice(); // 수량 변경 시 총 금액 업데이트
                } else if (selectedQuantity < 1) {
                    quantityInput.value = 1;
                }
            }

            function updateTotalPrice() {
                const quantityInput = document.getElementById("numInput");
                if (!areAllOptionsSelected()) {
                    alert("옵션을 먼저 선택해 주세요.");
                    quantityInput.value = 1;
                    return;
                }
                const quantity = parseInt(document.getElementById("numInput").value, 10) || 1;
                const totalPrice = unitPrice * quantity;
                document.getElementById("totalPrice").textContent = totalPrice.toLocaleString() + "원"; // 총 상품 금액 표시 업데이트
            }

            function changeNumNoOpt(delta) {

                console.log('ㄷㅇㅇㅇㅇ')
                if (!areAllOptionsSelected()) {
                    console.log('asdf' + areAllOptionsSelected())
                    alert("옵션을 먼저 선택해 주세요.");
                    return;
                }

                const quantityInput = document.getElementById("numInput");
                let currentQuantity = parseInt(quantityInput.value, 10) || 1;
                currentQuantity += delta;

                if (currentQuantity < 1) {
                    currentQuantity = 1;
                }

                quantityInput.value = currentQuantity;
                checkMaxStock();
                updateTotalPrice();
            }

            function validateBeforeAction() {
                if (!areAllOptionsSelected()) {
                    alert("모든 옵션을 선택해주세요.");
                    return false;
                }

                const maxStock = getStockForSelectedOptions();
                const quantityInput = document.getElementById("numInput");
                const selectedQuantity = parseInt(quantityInput.value, 10) || 1;

                if (selectedQuantity > maxStock) {
                    alert(`최대 재고 수량은 ${maxStock}입니다.`);
                    quantityInput.value = maxStock;
                    return false;
                }

                return true;
            }

            function addToCart() {
                if (!validateBeforeAction()) return;

                const productId = document.getElementById('prodNo').textContent.trim();
                const quantity = parseInt(document.getElementById('numInput').value, 10) || 1;
                const details = getDetailsForSelectedOptions();
                const combinationId = details.combinationId;
                const totalPrice = document.getElementById("totalPrice").textContent
                    .replace(/[^\d]/g, '')  // 숫자가 아닌 모든 문자 제거
                    .trim();


                if (!combinationId) {
                    alert("선택한 옵션 조합에 해당하는 상품이 없습니다.");
                    return;
                }

                fetch('/cart/insert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        productId: productId,
                        quantity: quantity,
                        combinationId: combinationId,
                        totalPrice: totalPrice
                    }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const userChoice = confirm("장바구니 담기에 성공했습니다! 장바구니로 이동할까요?");
                            if (userChoice) {
                                window.location.href = '/product/cart';
                            } else {
                                window.location.reload();
                            }
                        } else {
                            alert("장바구니 담기에 실패했습니다.");
                        }
                    })
                    .catch(error => {
                        console.error("에러 발생:", error);
                        alert("장바구니 담기에 실패했습니다.");
                    });
            }

            window.updateSelectedOptions = updateSelectedOptions;
            window.changeNumNoOpt = changeNumNoOpt;
            window.checkMaxStock = checkMaxStock;
            window.validateBeforeAction = validateBeforeAction;
            window.addToCart = addToCart;
            window.updateTotalPrice = updateTotalPrice;
        });

    </script>






</section>
</html>